% # context : data, utils, module
\newpage
%% set year=utils.semestre2year(module.sem)|le
%% set possiblecomps=module.getParcours().getCompLevel(year)|sort(attribute='id')
%% set complettres=['X','A','B','C','D','E','F']
%% set targets=module.target.values()

\invisiblesubsubsection{SAÉ \VAR{module.id|le}~\emph{\VAR{module.getShortname()|le}}}\label{FICHE-\VAR{module.id|le}}
\selectparcours{\VAR{module.getParcours().getCanonical()|le}}
\begin{tikzpicture}[remember picture,overlay,x=1mm,y=1mm,every node/.style={inner sep=0pt,outer sep=0pt}]
  \coordinate (NW) at (2,42);
  \coordinate (NE) at (188,42);
  \coordinate (NWi) at (10,42);
  \coordinate (NEi) at (180,42);
  \coordinate (NW) at (current page.north west);
  \coordinate (NE) at (current page.north east);
  \coordinate (NWi) at ($ (NW)+(18,0) $);
  \coordinate (NEi) at ($ (NE)+(-18,0) $);
  \coordinate (start) at ($ (current page.north west)+(0,-40) $);
  \coordinate (mark5) at ($ 1/2*(NWi)+1/2*(NEi)+1/2*(-10,0) $);
  \path ($ (mark5)-(NWi) $);\pgfgetlastxy{\xmarkfive}{\ymarkfive};
  \coordinate (mark4) at ($ 2/3*(NWi)+1/3*(NEi)+1/3*(-16,0) $);
  \coordinate (mark6) at ($ 1/3*(NWi)+2/3*(NEi)+1/3*(-14,0) $);
  \coordinate (mark0) at ($ (NEi)+(-4,0) $);
  \draw[black,line width=1mm] (start-|NW)--(start-|NWi);
  \draw[black,line width=1mm] ($ (start-|NW)+(0,10) $)--($ (start-|NWi)+(0,10) $);
  \node[draw,black,fill=black,text=white,line width=1mm,rounded corners=5mm,text width=30mm,minimum height=30mm,anchor=south west,inner sep=0pt,outer sep=0pt] (bigtitle) at ($ (start-|NWi)+(0,-10) $) {\centering\LARGE\bfseries\selectfont S.A.É.\\\vspace*{2mm}\fontsize{32}{32}\bfseries\selectfont \VAR{module.id|le}};
  \draw[black,line width=1mm] ($ (start-|NWi)+(30,0) $)--(start-|NE);
  \draw[black,line width=1mm] ($ (start-|NWi)+(30,10) $)--($ (start-|NE)+(0,10) $);
  \node[anchor=west,color=blacktextemphcolor,text height=3ex,text depth=1ex] at ($ (start-|NWi)+(32,5) $) {\normalfont\fontsize{13}{13}\bfseries\color{blacktextemphcolor}\VAR{module.getName()|le}};
  \coordinate (last) at (NEi|-start);
  %% for comp in targets
  \node[anchor=north east] (ariane) at ($ (last)+(0,-1) $) {%
    \normalfont\fontsize{9}{9}\bfseries\color{blacktextdimmedcolor}%
    Compétence \VAR{comp.number} : \VAR{comp.getShortname()|le}
    \color{blacktextdimmedcolor!50!whitepagecolor}
    >
    \VAR{module.getShortname()|le}%
  };
  \coordinate (last) at (ariane.south east);
  %% endfor
  \coordinate (arianesouth) at (last);
  %% include 'Fresco.tex'
  \node[fit=(bigtitle.south)(arianesouth)] (bottom) {};
  \coordinate (last) at ($ (bottom.south)+(0,-3) $);
  \coordinate (lasteast) at (last-|NEi);
  \coordinate (lastwest) at (last-|NWi);
  \node[anchor=north west,text width={\xmarkfive}] (titredescriptif) at ($ (lastwest)+(2,-2) $) {
    \sloppy\bfseries\large\color{blacktextemphcolor}\selectfont
    Descriptif détaillé
  };
  \coordinate (last) at (titredescriptif.south-|NWi);
  \node[anchor=north west,text width={\xmarkfive}] (descriptif) at ($ (last)+(2,0) $) {
    \setlength\topsep{0pt}\setlength\partopsep{0pt}\begin{flushleft}
      %% if module.description
      \textbf{En quoi consiste cette SAÉ ?}\\
      \VAR{module.description|le|join('\\par\n')}
      %% endif
      %% set precos=module.guideline
      %% set livrables=module.production
      %% if livrables|length>0
      \\
      \textbf{Quelles sont les productions de cette SAÉ ?}\\
      \begin{itemize}[nosep,topsep=0pt,label=\textitemize,leftmargin=1pc,labelsep=*]
        %% for s in livrables
      \item \VAR{s|le}
        %% endfor
      \end{itemize}
      %% endif
      %% if precos|length>0
      \textbf{Comment se fait le travail ?}\\
      La préconisation est : \VAR{precos|le}.
      %% endif
    \end{flushleft}
  };
  \coordinate (lastwest) at ($ (descriptif.south-|NWi)+(0,-4) $);
  
  %
  % Bilan horaire
  %
  
  \node[%
  inner sep=2mm,rounded corners=2mm,%
  line width=.5mm,draw=black,%
  text width={\xmarkfive},anchor=north east] (combobox) at (lasteast-|NEi) {%
    {\large\bfseries Cursus}\hfill S\VAR{module.sem|le}\\
    %% set hoursout=data.getHours(source=module)
    %% set hoursin=data.getHours(destination=module)
    %% if hoursin.sum(onlyType=['PROJ'])>0
    \textbf{Travail encadré (projet tutoré)}\dotfill
    \textcolor{blacktextemphcolor}{\bfseries\VAR{hoursin.sum(onlyType=['PROJ'])|hours}} PT%
    \\
    %% endif
    \textbf{Formation complémentaire}\dotfill%
    \textcolor{blacktextemphcolor}{\bfseries\VAR{hoursin.sum(onlyType=['TD'])|hours}} TD et 
    \textcolor{blacktextemphcolor}{\bfseries\samebox{\bfseries 00h}{\VAR{hoursin.sum(onlyType=['TP'])|hours}}} TP\\
    %% set allress=data.getModule(onlyType='RESS',semestre=module.sem)|sort(attribute='id')
    %% for ress in allress if ress in hoursin.sources() or ress in module.ress.values()
    %% if loop.first
    Lien\VAR{'s' if loop.length>1 else ''} avec les ressources :\hfill    \llap{\rule[2.1ex]{8em}{1pt}}
    \\
    %% endif
    \hyperref[FICHE-\VAR{ress.id|le}]{\VAR{ress.id|le}~\VAR{ress.getShortname()|le}}
    %% if hoursin.sum(source=ress)>0
    \dotfill
    \VAR{hoursin.sum(source=ress,onlyType=['TD'])|hours} TD et 
    \samebox{\bfseries 00h}{\VAR{hoursin.sum(source=ress,onlyType=['TP'])|hours}} TP
    %% endif
    \\
    %% endfor
    Cela représente un total (encadrement et formation confondus) de \textcolor{blacktextemphcolor}{\bfseries\VAR{hoursin.sum()|hours}}.
  };

  \coordinate (lasteast) at ($ (combobox.south-|NEi)+(0,-2) $);

  %% include 'CompFragment.tex'

  %% set exemples=module.model.values()
  %% for ex in exemples
  \compareytozero{($ (lasteast)-(lastwest) $)}{\coordinate(stpoint) at (lastwest);}{\coordinate(stpoint) at ($ (lasteast)-(mark5)+(NWi)+(-4,0) $);}

  \node[inner sep=2mm,rounded corners=2mm,%
  line width=.5mm,draw=blacktextcolor,%
  text width={\xmarkfive},anchor=north west] (exemple) at (stpoint) {%
    \parbox{.9\linewidth}{\raggedright\large\bfseries \VAR{ex.getName()|le}}\\
    \VAR{ex.synopsis|le|join('\n\n')}
    %% if ex.format|length > 0
    \\
    %% if ex.format|length > 6
    {\small Formats pédagogiques : \VAR{ex.format|le}}
    %% else
    {\small Format pédagogique : \VAR{ex.format|le}}
    %% endif
    %% endif
    \par
    \small
    %% if ex.objective|length > 0
    \textitemizesecondary Problématique professionnelle~: \VAR{ex.objective|join('\n\n')|le}\par
    %% endif
    %% if ex.evaluation|length > 0
    \textitemizesecondary Préconisations d'évaluation~: \VAR{ex.evaluation|join('\n\n')|le}\par
    %% endif
  };
  \node[draw=whitetextcolor,rounded corners=1mm,inner sep=1mm,anchor=north east,fill=blackpagecolor] (coeffs) at ($ (exemple.north east)+(-1,-1) $)
  {\textcolor{whitetextcolor}{\large\bfseries Ex. \VAR{ex.number|le}}};
  \compareytozero{($ (lasteast)-(lastwest) $)}{\coordinate(lastwest) at ($ (exemple.south west-|NWi)+(0,-2) $);}{\coordinate(lasteast) at ($ (exemple.south east-|NEi)+(0,-2) $);}
  %% endfor

  \begin{pgfonlayer}{bg}
    \node[inner sep=2mm,rounded corners=2mm,draw=blacktextcolor,line width=.5mm,fit=(descriptif) (titredescriptif)]{};
  \end{pgfonlayer}
\end{tikzpicture}





\vfill
