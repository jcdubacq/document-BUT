% # context : data, module, year, complettres
%% for complevel in module.getNiveauCompetence()|sort(attribute='id')
%% set comp=complevel.parent
%% set compnum=comp.number|int
%% set compltr=complettres[compnum]
%% set acs=module.ac.values()|sort(attribute='num')|selectattr('parent','==',complevel)
%% set coeffs=module.getCoeff(comp=comp)|first
%% set ue=complevel.getUE(semestre=module.sem)
%% set coeffsum=ue.getCoeff()|map(attribute='value')|map('int')|sum
%% set coeffsumstr=('/'+coeffsum) if coeffsum!=100 else '%'
\compareytozero{($ (lasteast)-(lastwest) $)}{\coordinate(stpoint) at (lastwest);}{\coordinate(stpoint) at ($ (lasteast)-(mark5)+(NWi)+(-4,0) $);}
\node[text=comp\VAR{compltr}pcolor,fill=comp\VAR{compltr}color,%
inner sep=2mm,rounded corners=2mm,%
line width=.5mm,draw=comp\VAR{compltr}color,%
text width={\xmarkfive},anchor=north west] (ac\VAR{compnum}title) at (stpoint) {%
  \Large\bfseries
  %% if comp.isPlural()>1
  \VAR{comp.getName()}
  %% else
  CompÃ©tence \VAR{compnum}
  %% endif
};
%% if coeffs
\node[draw=blackpagecolor,inner sep=1mm,anchor=north east,fill=whitepagecolor,rounded corners] (coeffs) at ($ (ac\VAR{compnum}title.north east)+(-1,-1) $)
{\textcolor{blacktextcolor}{\large\bfseries\VAR{coeffs.value|le}\VAR{coeffsumstr|le}}};
%% endif

\coordinate (last) at (ac\VAR{compnum}title.south west);
\node[text=blacktextcolor,fill=comp\VAR{compltr}color!25!whitepagecolor,%
inner sep=2mm,%
text width={\xmarkfive},anchor=north west] (ac\VAR{compnum}level) at ($ (last)+(0,1.5) $) {%
  \setlength\topsep{0pt}\setlength\partopsep{0pt}\begin{flushleft}
    \VAR{complevel.getName()|le}
  \end{flushleft}
};
\coordinate (last) at (ac\VAR{compnum}level.south west);
\node[text=blacktextcolor,fill=comp\VAR{compltr}color!25!whitepagecolor,%
inner sep=2mm,%
text width={\xmarkfive},anchor=north west] (ac\VAR{compnum}acs) at ($ (last)+(0,1.5) $) {
  \setlength\topsep{0pt}\setlength\partopsep{0pt}\begin{flushleft}
    %% if acs
    %% for ac in acs
    %% if not ac.isPlural()>1
    \textbf{AC \VAR{ac.num|le}}
    %% endif
    \VAR{ac.getName()|le}
    %% if not loop.last
    \par
    %% endif
    %% endfor
    %% else
    (pas d'apprentissage critique)
    %% endif
  \end{flushleft}
};
\draw[line width=.5mm,draw=comp\VAR{compltr}color] (ac\VAR{compnum}title.base west)--(ac\VAR{compnum}acs.south west)--(ac\VAR{compnum}acs.south east)--(ac\VAR{compnum}title.base east);
\draw[line width=.5mm,draw=comp\VAR{compltr}color,dotted] ($ (0,-1)+(ac\VAR{compnum}acs.north west) $)--($ (0,-1)+(ac\VAR{compnum}acs.north east) $);
\compareytozero{($ (lasteast)-(lastwest) $)}{\coordinate(lastwest) at ($ (ac\VAR{compnum}acs.south west)+(0,-2) $);}{\coordinate(lasteast) at ($ (ac\VAR{compnum}acs.south east)+(0,-2) $);}
%% endfor
